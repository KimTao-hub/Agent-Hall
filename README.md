# Agent-Dev
- 主要功能：提供Agent大厅
  - 小红书智能文案生成器：根据用户输入的场景和参数，生成符合小红书风格的文案
  - 其余Agent待开发...


## 1. 后端系统概述
### 1.0 前言
- 本项目后端系统基于Node.js和Express.js构建，主要负责处理前端请求、调用OpenAI API生成文案、管理系统配置等核心功能。
- 系统采用RESTful API设计，前端通过HTTP请求与后端交互。
### 1.1 环境配置
- **.env文件**:
  ```
  DEEPSEEK_API_KEY=your_api_key_here
  PORT=8015
  ```
### 1.2 开发环境启动
```bash
cd backend
pnpm install
pnpm run dev
```
### 1.3 生产环境部署
```bash
cd backend
pnpm install
pnpm run build
pnpm start
```

### 1.4 技术栈
- **编程语言**: TypeScript
- **Web框架**: Express.js
- **AI集成**: OpenAI SDK (集成DeepSeek API)
- **环境管理**: dotenv
- **日志系统**: winston
- **安全措施**: express-rate-limit
- **包管理**: pnpm

### 1.5 系统架构图
```
┌─────────────────┐     ┌─────────────────┐     ┌─────────────────┐
│   前端应用      │     │   后端服务      │     │  DeepSeek API   │
│   (Next.js)     │────>│   (Express)     │────>│   (OpenAI SDK)  │
└─────────────────┘     └─────────────────┘     └─────────────────┘
        ▲                        │                        │
        │                        │                        │
        └────────────────────────┘                        │
                         │                                 │
                         └─────────────────────────────────┘
```

## 2. 核心模块功能说明

### 2.1 环境配置模块 (`src/env.ts`)
- **功能**: 负责加载和管理环境变量
- **实现细节**:
  - 使用dotenv加载.env文件中的配置
  - 设置OPENAI_API_KEY环境变量，确保OpenAI SDK正确初始化
  - 在所有模块加载之前执行，确保环境变量的可用性

### 2.2 OpenAI服务模块 (`src/openaiService.ts`)
- **功能**: 封装OpenAI SDK调用，处理AI模型请求
- **核心功能**:
  - 初始化OpenAI实例，配置DeepSeek API 
  - 实现聊天对话功能，支持流式响应 (createChatCompletion,createChatCompletionStream)
  - 提供详细的日志记录 (记录请求参数、响应数据、错误信息)
  - 处理API调用错误 (捕获OpenAI SDK异常，返回友好错误提示)s

### 2.3 Agent模块 (`src/agent.ts`)
- **功能**: 维护对话上下文，管理聊天历史
- **核心功能**:
  - 管理对话历史记录 (addMessage、getHistory、clearHistory)
  - 自动裁剪过长的历史记录 (trimHistory,保存20条)
  - 调用OpenAI服务生成响应 (generateResponse ->createChatCompletionStream)
  - 处理流式响应的回调 (onChunk)

### 2.4 服务器模块 (`src/index.ts`)
- **功能**: 提供HTTP API端点，处理客户端请求
- **核心功能**:
  - 配置Express中间件 (CORS、JSON解析、日志记录)
  - 实现API端点 (POST /chat, GET /history, POST /clear, GET /health)
  - 处理请求限流 (express-rate-limit)
  - 提供健康检查 (GET /health)
  - 全局错误z处理 --中间件(捕获所有未处理异常)

## 3. 主要业务流程

### 3.1 聊天对话流程

#### 数据流向
```
前端输入 → API请求 → 服务器处理 → Agent处理 → OpenAI服务调用 → DeepSeek API → 流式响应 → 前端展示
```

#### 处理步骤
1. **接收请求**:
   - 前端发送POST请求到`/chat`端点
   - 服务器验证请求参数

2. **上下文处理**:
   - Agent添加用户消息到对话历史
   - Agent裁剪过长的历史记录

3. **AI调用**:
   - OpenAI服务创建流式聊天请求
   - 发送请求到DeepSeek API
   - 接收流式响应

4. **响应处理**:
   - 逐块处理AI响应
   - 通过Server-Sent Events流式返回给前端
   - 更新对话历史

5. **错误处理**:
   - 捕获API调用错误
   - 返回友好的错误提示
   - 记录详细的错误信息

## 4. 关键API接口说明

### 4.1 `/chat` (POST)
- **功能**: 处理聊天消息，返回AI响应
- **请求体**:
  ```json
  {
    "message": "用户消息内容"
  }
  ```
- **响应**: 流式文本响应
- **状态码**:
  - 200: 成功
  - 400: 请求参数错误
  - 500: 服务器内部错误

### 4.2 `/history` (GET)
- **功能**: 获取聊天历史记录
- **响应**:
  ```json
  [
    {
      "role": "system",
      "content": "系统提示"
    },
    {
      "role": "user",
      "content": "用户消息"
    },
    {
      "role": "assistant",
      "content": "AI响应"
    }
  ]
  ```

### 4.3 `/clear` (POST)
- **功能**: 清除聊天历史记录
- **响应**:
  ```json
  {
    "success": true
  }
  ```

### 4.4 `/health` (GET)
- **功能**: 健康检查
- **响应**:
  ```json
  {
    "status": "ok",
    "timestamp": "2026-02-03T14:30:00Z"
  }
  ```

## 5. 数据库设计与交互逻辑

### 5.1 数据存储方案
- **当前实现**: 内存存储
  - 对话历史存储在Agent实例的内存中
  - 服务重启后数据会丢失

### 5.2 未来扩展建议
- **Redis存储**:
  - 优点: 高性能，支持TTL，适合会话管理
  - 实现: 使用Redis存储对话历史，设置合理的过期时间

- **数据库存储**:
  - 优点: 持久化存储，支持复杂查询
  - 实现: 使用PostgreSQL存储对话历史，设计合理的表结构

## 6. 重要的技术实现细节

### 6.1 流式响应实现
- **技术**: Server-Sent Events (SSE)
- **实现**: 
  - 使用Express的`res.write()`方法逐块发送数据
  - 设置`Transfer-Encoding: chunked`头
  - 前端使用`getReader()`处理流式响应

### 6.2 错误处理机制
- **多层错误捕获**:
  - API端点级错误捕获
  - Agent级错误捕获
  - OpenAI服务级错误捕获
  - 全局错误处理中间件

- **错误类型处理**:
  - API调用失败 (402, 403等)
  - 参数错误
  - 网络错误
  - 服务内部错误

### 6.3 安全性措施
- **请求限流**:
  - 使用express-rate-limit限制请求频率
  - 防止API滥用

- **敏感信息保护**:
  - 使用环境变量管理API密钥
  - 避免在日志中记录敏感信息
  - 不在响应中暴露内部错误细节

### 6.4 性能优化
- **对话历史管理**:
  - 自动裁剪过长的历史记录
  - 只保留最近的对话内容

- **流式处理**:
  - 减少用户等待时间
  - 提高系统响应速度

## 8. 代码结构

```
backend/
├── src/
│   ├── env.ts              # 环境变量配置
│   ├── openaiService.ts    # OpenAI SDK封装
│   ├── agent.ts            # 对话管理
│   ├── index.ts            # 服务器主文件
│   └── openaiService.test.ts # 测试文件
├── logs/
│   ├── combined.log        # 综合日志
│   └── error.log           # 错误日志
├── .env                    # 环境配置文件
├── package.json            # 项目配置
├── pnpm-lock.yaml          # 依赖锁文件
└── tsconfig.json           # TypeScript配置
```

## 9. 常见问题与解决方案

### 9.1 API调用失败
- **症状**: 前端显示"I apologize, but I encountered an error while processing your request"
- **原因**: 
  - API密钥无效或过期
  - 账户余额不足
  - 网络连接问题
- **解决方案**:
  - 检查API密钥配置
  - 充值DeepSeek账户
  - 检查网络连接

### 9.2 前端无法连接后端
- **症状**: 浏览器控制台显示"Failed to fetch"
- **原因**:
  - 后端服务未运行
  - 端口配置错误
  - CORS配置问题
- **解决方案**:
  - 启动后端服务
  - 检查前端API地址配置
  - 检查CORS中间件配置

### 9.3 流式响应不工作
- **症状**: 前端等待完整响应后才显示
- **原因**:
  - 后端未启用流式响应
  - 前端未正确处理流式响应
- **解决方案**:
  - 确保后端设置了`stream: true`
  - 检查前端`getReader()`实现

## 10. 技术栈选择理由

- **TypeScript**: 提供类型安全，减少运行时错误
- **Express.js**: 轻量高效，适合构建API服务
- **OpenAI SDK**: 官方支持，集成方便，功能完善
- **winston**: 强大的日志系统，支持多传输目标
- **express-rate-limit**: 简单有效的请求限流方案
- **pnpm**: 高性能包管理器，节省磁盘空间

## 11. 未来扩展建议

1. **多模型支持**: 集成多个AI模型，根据不同场景选择合适的模型
2. **会话管理**: 实现用户会话管理，支持多用户同时使用
3. **工具集成**: 添加更多工具能力，如web搜索、文件处理等
4. **监控系统**: 实现更完善的监控和告警机制
5. **缓存系统**: 添加响应缓存，提高系统性能
6. **文档完善**: 添加Swagger文档，自动生成API文档

## 12. 小红书Agent功能介绍

### 12.1 功能概述
小红书Agent是一个专门为小红书平台设计的智能文案生成系统，支持8大核心内容场景：美妆护肤、时尚穿搭、旅行攻略、美食探店、家居好物、健身运动、育儿分享、科技数码。

### 12.2 核心功能
1. **场景选择**: 直观的场景导航界面，支持8大核心场景
2. **参数配置**: 场景化的参数表单，根据不同场景提供定制化输入字段
3. **智能生成**: 基于AI的文案生成引擎，根据场景和参数生成高质量小红书风格文案
4. **文案编辑**: 实时编辑功能，支持标签管理和格式调整
5. **效果预览**: 小红书风格的实时预览，支持一键复制

### 12.3 使用示例

#### 示例1: 美妆护肤场景
**输入参数**:
- 产品名称: XX品牌精华液
- 品牌: XX护肤
- 价格: 299
- 适合肤质: 干性
- 使用感受: 质地轻薄，易吸收，不油腻
- 效果: 保湿效果明显，肌肤变得光滑细腻

**生成文案**:
```
💖 挖到宝了！这款精华液让我的干皮起死回生～

最近被闺蜜安利了XX品牌的这款精华液，用了两周真的惊艳到我了！

✨ 质地：轻薄如水，上脸秒吸收，完全不油腻，夏天用也毫无负担
✨ 效果：干皮救星本星！原本卡粉的脸颊现在变得水当当，早上起床皮肤还是透亮的
✨ 价格：299元/30ml，性价比超高，学生党也能负担

成分党看过来：主打玻尿酸和神经酰胺，深层补水同时修护屏障，敏感肌也可以放心用～

干皮姐妹一定要试试，我已经安利给身边所有干皮朋友了！
#护肤好物 #干皮救星 #精华液推荐
```

#### 示例2: 旅行攻略场景
**输入参数**:
- 目的地: 三亚
- 行程天数: 5
- 预算: 5000
- 主要景点: 亚龙湾、蜈支洲岛、天涯海角
- 特色美食: 海鲜、清补凉、海南粉

**生成文案**:
```
🌴 三亚5天4晚超详细攻略，人均5000玩到爽！

前阵子和闺蜜去了三亚，做了超详细的攻略，玩得超开心，分享给大家～

📅 行程安排：
Day1: 抵达三亚 → 亚龙湾海滩
Day2: 蜈支洲岛一日游
Day3: 天涯海角 → 鹿回头
Day4: 南山文化旅游区 → 大小洞天
Day5: 免税店购物 → 返程

🍤 必吃美食：
- 第一市场海鲜（推荐阿浪海鲜，新鲜又实惠）
- 椰梦长廊的清补凉（解暑神器）
- 街头小店的海南粉（地道又便宜）

💰 省钱贴士：
- 机票提前1个月订，避开节假日
- 住宿选择亚龙湾附近，性价比高
- 景点门票在网上预订，比现场买便宜

☀️ 注意事项：
- 防晒！防晒！防晒！重要的事情说三遍
- 带好泳衣和沙滩鞋
- 准备一些现金，部分小店可能不支持移动支付

三亚真的是国内最适合度假的地方了，蓝天碧海白沙滩，随便拍都好看～
#三亚旅行 #旅行攻略 #海岛度假
```

### 12.4 技术实现
- **前端**: React + Next.js + TypeScript
- **后端**: Node.js + Express + TypeScript
- **AI集成**: OpenAI SDK (集成DeepSeek API)
- **数据流**: 前端 → 后端API → AI服务 → 流式响应 → 前端展示

## 13. 总结

本后端系统实现了一个基于DeepSeek API的智能聊天服务，具有以下特点：

- **模块化设计**: 清晰的代码结构，易于维护和扩展
- **流式响应**: 提供实时的AI响应，提升用户体验
- **完整的错误处理**: 确保系统在各种异常情况下的稳定性
- **详细的日志记录**: 便于问题排查和系统监控
- **安全的配置管理**: 保护敏感信息，防止API滥用

系统已经完全搭建完成，可以与前端应用集成使用，为用户提供智能的聊天交互体验。

此外，系统还集成了专门的小红书Agent功能，为小红书平台用户提供高质量的文案生成服务，支持8大核心内容场景，通过场景化的参数配置和AI智能生成，帮助用户快速创建符合小红书平台风格的优质内容。